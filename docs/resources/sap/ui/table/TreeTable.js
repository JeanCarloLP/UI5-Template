/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./Table","./TableRenderer","sap/ui/model/ClientTreeBindingAdapter","sap/ui/model/TreeBindingCompatibilityAdapter","./library","./utils/TableUtils","./plugins/BindingSelection","sap/base/Log","sap/base/assert"],function(e,t,r,o,n,i,a,s,p){"use strict";var l=e.extend("sap.ui.table.TreeTable",{metadata:{library:"sap.ui.table",properties:{expandFirstLevel:{type:"boolean",defaultValue:false,deprecated:true},useGroupMode:{type:"boolean",group:"Appearance",defaultValue:false},groupHeaderProperty:{type:"string",group:"Data",defaultValue:null},collapseRecursive:{type:"boolean",defaultValue:true,deprecated:true},rootLevel:{type:"int",group:"Data",defaultValue:0,deprecated:true}},events:{toggleOpenState:{parameters:{rowIndex:{type:"int"},rowContext:{type:"object"},expanded:{type:"boolean"}}}}},renderer:"sap.ui.table.TableRenderer"});l.prototype.init=function(){e.prototype.init.apply(this,arguments);i.Grouping.setToDefaultTreeMode(this);i.Hook.register(this,i.Hook.Keys.Row.UpdateState,u,this);i.Hook.register(this,i.Hook.Keys.Row.Expand,d,this);i.Hook.register(this,i.Hook.Keys.Row.Collapse,f,this)};l.prototype._bindRows=function(t){if(!t.parameters){t.parameters={}}if(!("rootLevel"in t.parameters)){t.parameters.rootLevel=this.getRootLevel()}if(!("collapseRecursive"in t.parameters)){t.parameters.collapseRecursive=this.getCollapseRecursive()}if(!("numberOfExpandedLevels"in t.parameters)){t.parameters.numberOfExpandedLevels=this.getExpandFirstLevel()?1:0}return e.prototype._bindRows.call(this,t)};function u(e){var t=this.getBinding();var r=e.context;e.context=r.context;if(!e.context){return}e.level=r.level+1;if(t.nodeHasChildren){e.expandable=t.nodeHasChildren(r)}else{e.expandable=t.hasChildren(r.context)}e.expanded=r.nodeState.expanded;if(i.Grouping.isInGroupMode(this)){var o=this.getGroupHeaderProperty();if(o){e.title=e.context.getProperty(o)}if(e.expandable){e.type=e.Type.GroupHeader;e.contentHidden=true}}}function d(e){var t=e.getIndex();var r=g(this,t,true);if(typeof r==="boolean"){this._onGroupHeaderChanged(t,r)}}function f(e){var t=e.getIndex();var r=g(this,t,false);if(typeof r==="boolean"){this._onGroupHeaderChanged(t,r)}}function g(e,t,r){var o=[];var n=e.getBinding();if(!n||t==null){return null}if(typeof t==="number"){o=[t]}else if(Array.isArray(t)){if(r==null&&t.length>1){return null}o=t}var i=e._getTotalRowCount();var a=o.filter(function(e){var t=n.isExpanded(e);var o=true;if(n.nodeHasChildren){if(n.getNodeByIndex){o=!n.nodeHasChildren(n.getNodeByIndex(e))}else{o=false}}return e>=0&&e<i&&!o&&r!==t}).sort(function(e,t){return e-t});if(a.length===0){return null}for(var s=a.length-1;s>0;s--){if(r){n.expand(a[s],true)}else{n.collapse(a[s],true)}}if(r===true){n.expand(a[0],false)}else if(r===false){n.collapse(a[0],false)}else{n.toggleIndex(a[0])}return n.isExpanded(a[0])}l.prototype.setFixedRowCount=function(e){s.warning('TreeTable: the property "fixedRowCount" is not supported and will be ignored!');return this};l.prototype.isTreeBinding=function(t){t=t||"rows";if(t==="rows"){return true}return e.prototype.isTreeBinding.apply(this,arguments)};l.prototype.getBinding=function(t){t=t==null?"rows":t;var n=e.prototype.getBinding.call(this,t);if(n&&t==="rows"&&!n.getLength){if(n.isA("sap.ui.model.odata.ODataTreeBinding")){o(n,this)}else if(n.isA("sap.ui.model.odata.v2.ODataTreeBinding")){n.applyAdapterInterface()}else if(n.isA("sap.ui.model.ClientTreeBinding")){r.apply(n)}else{s.error("Binding not supported by sap.ui.table.TreeTable")}}return n};l.prototype._getContexts=function(e,t,r){var o=this.getBinding();if(o){return o.getNodes(e,t,r)}else{return[]}};l.prototype._getRowContexts=function(){var t=this._getTotalRowCount();var r=e.prototype._getRowContexts.apply(this,arguments);var o=this._getTotalRowCount();if(i.isVariableRowHeightEnabled(this)&&t!==o){return e.prototype._getRowContexts.apply(this,arguments)}return r};l.prototype._onGroupHeaderChanged=function(e,t){this.fireToggleOpenState({rowIndex:e,rowContext:this.getContextByIndex(e),expanded:t})};l.prototype.expand=function(e){g(this,e,true);return this};l.prototype.collapse=function(e){g(this,e,false);return this};l.prototype.collapseAll=function(){var e=this.getBinding();if(e){e.collapseToLevel(0);this.setFirstVisibleRow(0)}return this};l.prototype.expandToLevel=function(e){var t=this.getBinding();p(t&&t.expandToLevel,"TreeTable.expandToLevel is not supported with your current Binding. Please check if you are running on an ODataModel V2.");if(t&&t.expandToLevel){t.expandToLevel(e)}return this};l.prototype.isExpanded=function(e){var t=this.getBinding();if(t){return t.isExpanded(e)}return false};l.prototype.getContextByIndex=function(e){var t=this.getBinding();if(t){return t.getContextByIndex(e)}};l.prototype.setRootLevel=function(e){this.setFirstVisibleRow(0);var t=this.getBinding();if(t){p(t.setRootLevel,"rootLevel is not supported by the used binding");if(t.setRootLevel){t.setRootLevel(e)}}this.setProperty("rootLevel",e,true);return this};l.prototype.setCollapseRecursive=function(e){var t=this.getBinding();if(t){p(t.setCollapseRecursive,"Collapse Recursive is not supported by the used binding");if(t.setCollapseRecursive){t.setCollapseRecursive(e)}}this.setProperty("collapseRecursive",!!e,true);return this};l.prototype.setUseGroupMode=function(e){this.setProperty("useGroupMode",!!e);h(this);return this};l.prototype.setEnableGrouping=function(){s.warning("The property enableGrouping is not supported by the sap.ui.table.TreeTable control");return this};l.prototype.setGroupBy=function(){s.warning("The groupBy association is not supported by the sap.ui.table.TreeTable control");return this};l.prototype.setUseFlatMode=function(e){this._bFlatMode=!!e;h(this);return this};function h(e){if(e.getUseGroupMode()){i.Grouping.setHierarchyMode(e,i.Grouping.HierarchyMode.GroupedTree)}else if(e._bFlatMode){i.Grouping.setToDefaultFlatMode(e)}else if(!e._bFlatMode){i.Grouping.setToDefaultTreeMode(e)}}l.prototype._createLegacySelectionPlugin=function(){return new a};return l});