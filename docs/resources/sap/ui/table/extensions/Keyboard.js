/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./ExtensionBase","./KeyboardDelegate","../utils/TableUtils","sap/ui/core/delegate/ItemNavigation","sap/ui/Device","sap/ui/dom/containsOrEquals","sap/ui/thirdparty/jquery"],function(e,t,i,o,a,n,s){"use strict";var l={_forward:function(e,t){var i=e._getItemNavigation();if(i!=null&&!e._getKeyboardExtension()._isItemNavigationSuspended()&&!t.isMarked("sapUiTableSkipItemNavigation")){i["on"+t.type](t)}},onfocusin:function(e){l._forward(this,e)},onsapfocusleave:function(e){l._forward(this,e)},onmousedown:function(e){l._forward(this,e)},onsapnext:function(e){l._forward(this,e)},onsapnextmodifiers:function(e){l._forward(this,e)},onsapprevious:function(e){l._forward(this,e)},onsappreviousmodifiers:function(e){l._forward(this,e)},onsappageup:function(e){l._forward(this,e)},onsappagedown:function(e){l._forward(this,e)},onsaphome:function(e){l._forward(this,e)},onsaphomemodifiers:function(e){l._forward(this,e)},onsapend:function(e){l._forward(this,e)},onsapendmodifiers:function(e){l._forward(this,e)},onsapkeyup:function(e){l._forward(this,e)}};var r={onBeforeRendering:function(e){this._oStoredFocusInfo=this.getFocusInfo()},onAfterRendering:function(e){var t=e&&e.isMarked("renderRows");this._getKeyboardExtension().invalidateItemNavigation();if(this._oStoredFocusInfo&&this._oStoredFocusInfo.customId){if(t){this.applyFocusInfo(this._oStoredFocusInfo)}else{this._getKeyboardExtension().initItemNavigation()}}delete this._oStoredFocusInfo},onfocusin:function(e){var t=this._getKeyboardExtension();if(!t._bIgnoreFocusIn){t.initItemNavigation()}else{e.setMarked("sapUiTableIgnoreFocusIn")}if(e.target&&e.target.id===this.getId()+"-rsz"){e.preventDefault();e.setMarked("sapUiTableSkipItemNavigation")}}};var f={_initItemNavigation:function(e){var t=e.getTable();if(!t){return}var a=t.$();var n=t.getRows().length;var l=i.getVisibleColumnCount(t);var r=i.hasRowHeader(t);var d=i.hasRowActions(t);var u=i.hasFixedColumns(t);var c;var g=[],p,v,h,_,m;if(u){h=a.find(".sapUiTableCtrlFixed.sapUiTableCtrlRowFixed:not(.sapUiTableCHT)");_=a.find(".sapUiTableCtrlFixed.sapUiTableCtrlRowScroll:not(.sapUiTableCHT)");m=a.find(".sapUiTableCtrlFixed.sapUiTableCtrlRowFixedBottom:not(.sapUiTableCHT)")}var b=a.find(".sapUiTableCtrlScroll.sapUiTableCtrlRowFixed:not(.sapUiTableCHT)");var I=a.find(".sapUiTableCtrlScroll.sapUiTableCtrlRowScroll:not(.sapUiTableCHT)");var C=a.find(".sapUiTableCtrlScroll.sapUiTableCtrlRowFixedBottom:not(.sapUiTableCHT)");if(r){p=a.find(".sapUiTableRowSelectionCell").get();l++}if(d){v=a.find(".sapUiTableRowActionCell").get();l++}for(c=0;c<n;c++){if(r){g.push(p[c])}if(u){g=g.concat(h.find('tr[data-sap-ui-rowindex="'+c+'"]').find("td[tabindex]").get())}g=g.concat(b.find('tr[data-sap-ui-rowindex="'+c+'"]').find("td[tabindex]").get());if(u){g=g.concat(_.find('tr[data-sap-ui-rowindex="'+c+'"]').find("td[tabindex]").get())}g=g.concat(I.find('tr[data-sap-ui-rowindex="'+c+'"]').find("td[tabindex]").get());if(u){g=g.concat(m.find('tr[data-sap-ui-rowindex="'+c+'"]').find("td[tabindex]").get())}g=g.concat(C.find('tr[data-sap-ui-rowindex="'+c+'"]').find("td[tabindex]").get());if(d){g.push(v[c])}}if(t.getColumnHeaderVisible()){var R=[];var T=a.find(".sapUiTableCHT.sapUiTableCtrlFixed>tbody>tr");var w=a.find(".sapUiTableCHT.sapUiTableCtrlScroll>tbody>tr");var N=i.getHeaderRowCount(t);for(c=0;c<N;c++){if(r){R.push(t.getDomRef("selall"))}if(T.length){R=R.concat(s(T.get(c)).find(".sapUiTableHeaderCell").get())}if(w.length){R=R.concat(s(w.get(c)).find(".sapUiTableHeaderCell").get())}if(d){R.push(a.find(".sapUiTableRowActionHeaderCell").children().get(0))}}g=R.concat(g)}if(!e._itemNavigation){e._itemNavigation=new o;e._itemNavigation.setTableMode(true);e._itemNavigation.attachEvent(o.Events.AfterFocus,function(o){var a=i.getFocusedItemInfo(t);a.header=i.getHeaderRowCount(t);a.domRef=null;if(a.row>=a.header){e._oLastFocusedCellInfo=a}},t)}e._itemNavigation.setColumns(l);e._itemNavigation.setRootDomRef(a.find(".sapUiTableCnt").get(0));e._itemNavigation.setItemDomRefs(g);e._itemNavigation.setFocusedIndex(f.getInitialItemNavigationIndex(e));e._itemNavigationInvalidated=false},getInitialItemNavigationIndex:function(e){return i.hasRowHeader(e.getTable())?1:0},isItemNavigationInvalid:function(e){return!e._itemNavigation||e._itemNavigationInvalidated}};var d=e.extend("sap.ui.table.extensions.Keyboard",{_init:function(e,o,a){this._itemNavigation=null;this._itemNavigationInvalidated=false;this._itemNavigationSuspended=false;this._delegate=new t(o);this._actionMode=false;i.addDelegate(e,r,e);i.addDelegate(e,this._delegate,e);i.addDelegate(e,l,e);e._getItemNavigation=function(){return this._itemNavigation}.bind(this);return"KeyboardExtension"},_debug:function(){this._ExtensionHelper=f;this._ItemNavigationDelegate=l;this._ExtensionDelegate=r},destroy:function(){var t=this.getTable();if(t){t.removeEventDelegate(r);t.removeEventDelegate(this._delegate);t.removeEventDelegate(l)}if(this._itemNavigation){this._itemNavigation.destroy();this._itemNavigation=null}if(this._delegate){this._delegate.destroy();this._delegate=null}e.prototype.destroy.apply(this,arguments)}});d.prototype.initItemNavigation=function(){if(f.isItemNavigationInvalid(this)){f._initItemNavigation(this)}};d.prototype.invalidateItemNavigation=function(){this._itemNavigationInvalidated=true};d.prototype.setActionMode=function(e){if(!this._delegate){return}if(e===true&&!this._actionMode&&this._delegate.enterActionMode){this._actionMode=this._delegate.enterActionMode.apply(this.getTable(),Array.prototype.slice.call(arguments,1))===true}else if(e===false&&this._actionMode&&this._delegate.leaveActionMode){this._actionMode=false;this._delegate.leaveActionMode.apply(this.getTable(),Array.prototype.slice.call(arguments,1))}};d.prototype.isInActionMode=function(){return this._actionMode};d.prototype.updateNoDataAndOverlayFocus=function(){var e=this.getTable();var t=document.activeElement;if(!e||!e.getDomRef()){return}if(e.getShowOverlay()){if(n(e.getDomRef(),t)&&e.$("overlay")[0]!==t){this._oLastFocus={Ref:t,Pos:"overlay"};e.getDomRef("overlay").focus()}}else if(i.isNoDataVisible(e)&&e.$("noDataCnt")[0]!==t){if(n(e.getDomRef("tableCCnt"),t)){this._oLastFocus={Ref:t,Pos:"table content"};if(a.browser.safari){e.getDomRef("noDataCnt").getBoundingClientRect()}e.getDomRef("noDataCnt").focus()}else if(e.$("overlay")[0]===t){c(e,this)}}else if(this._oLastFocus){if(this._oLastFocus.Pos==="table content"){if(n(e.getDomRef("tableCCnt"),this._oLastFocus.Ref)){u(e,this)}else if(e.getRows()[0]&&e.getRows()[0].getDomRef("col0")){e.getRows()[0].getDomRef("col0").focus();this._oLastFocus=null}}else if(this._oLastFocus.Pos==="overlay"){if(n(e.getDomRef(),this._oLastFocus.Ref)){u(e,this)}else{c(e,this)}}}};function u(e,t){if(!s(t._oLastFocus.Ref).hasClass("sapUiTableCell")){var o=i.getParentCell(e,t._oLastFocus.Ref);if(o&&o[0]&&s(o[0]).hasClass("sapUiTableCell")){o[0].focus()}else{t._oLastFocus.Ref.focus()}}else{t._oLastFocus.Ref.focus()}t._oLastFocus=null}function c(e,t){if(e.getColumnHeaderVisible()){i.focusItem(e,f.getInitialItemNavigationIndex(t));t._oLastFocus=null}else if(i.isNoDataVisible(e)){e.getDomRef("noDataCnt").focus();t._oLastFocus=null}else if(e.getRows()[0]&&e.getRows()[0].getDomRef("col0")){e.getRows()[0].getDomRef("col0").focus();t._oLastFocus=null}}d.prototype._suspendItemNavigation=function(){this._itemNavigationSuspended=true};d.prototype._resumeItemNavigation=function(){this._itemNavigationSuspended=false};d.prototype._isItemNavigationSuspended=function(){return this._itemNavigationSuspended};d.prototype._getLastFocusedCellInfo=function(){var e=i.getHeaderRowCount(this.getTable());if(!this._oLastFocusedCellInfo||this._oLastFocusedCellInfo.header!=e){var t=i.getFocusedItemInfo(this.getTable());var o=f.getInitialItemNavigationIndex(this);return{cellInRow:o,row:e,header:e,cellCount:t.cellCount,columnCount:t.columnCount,cell:t.columnCount*e+o}}return this._oLastFocusedCellInfo};d.prototype._setSilentFocus=function(e){this._bIgnoreFocusIn=true;this._setFocus(e);this._bIgnoreFocusIn=false};d.prototype._setFocus=function(e){if(!e){return}var t=this.getTable();var o=i.getCellInfo(e);if(o.isOfType(i.CELLTYPE.ANY)&&t){var a=s(e);if(a.attr("tabindex")!="0"){var n=t._getItemNavigation();if(n&&n.aItemDomRefs){for(var l=0;l<n.aItemDomRefs.length;l++){if(n.aItemDomRefs[l]){n.aItemDomRefs[l].setAttribute("tabindex","-1")}}}a.attr("tabindex","0")}}e.focus()};d.prototype._getTableType=function(){return this._type};return d});